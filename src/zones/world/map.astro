---
import SkyLayout from "@/layouts/SkyLayout.astro";
import nowState from "@/content/now.state.json";
import courtyardState from "@/content/courtyard.state.json";
import fs from "fs";
import path from "path";

const nowMode = (nowState?.mode ?? "quiet").toString(); // live | quiet | dark
const courtyard = (courtyardState?.state ?? "quiet").toString(); // open | quiet | closed (per your validator)

const REG_PATH = path.join(process.cwd(), "starmap/registry/index.json");
const registry = JSON.parse(fs.readFileSync(REG_PATH, "utf-8"));
const codex = registry.filter((e) => e.type === "codex");

const mostRecentCodex = codex
  .map((e) => {
    const fp = path.join(process.cwd(), "starmap", e.path);
    return fs.existsSync(fp) ? fs.statSync(fp).mtime : null;
  })
  .filter(Boolean)
  .sort((a, b) => b - a)[0];

const codexFresh = mostRecentCodex ? mostRecentCodex.toLocaleDateString() : "—";
---
<SkyLayout title="Map" bg="sky">
  <div class="map">
    <div class="field">
     <a class={`pin p-now mode-${nowMode}`} href="/now" aria-label="Now"></a>
     <a class="pin p-walk" href="/walk" aria-label="Walk"></a>
     <a class={`pin p-courtyard state-${courtyard}`} href="/courtyard" aria-label="Courtyard"></a>
     <a class="pin p-codex" href="/codex" aria-label="Codex"></a>
    </div>

     <p class="readout">
  Present State · Codex updated {codexFresh} · Now: {nowMode} · Courtyard: {courtyard}
</p>

    <button id="glyph" class="glyph" aria-label="Go to Now">✦</button>
  </div>

  <style>
    .map{
      width:min(1100px,94vw);
      height:min(70vh,720px);
      margin:0 auto;
      border-radius:18px;
      overflow:hidden;
      position:relative;
      background:
        radial-gradient(900px 520px at 50% 35%, rgba(255,255,255,.08), rgba(0,0,0,.92));
      box-shadow: inset 0 0 160px rgba(0,0,0,.55), 0 28px 90px rgba(0,0,0,.35);
      opacity:0;
      transform: translateY(8px);
      animation: in 900ms ease forwards;
    }
    @keyframes in{ to{opacity:1; transform:translateY(0);} }

    .field{ position:absolute; inset:0; }

    .pin{
      position:absolute;
      width:18px;height:18px;border-radius:999px;
      background: radial-gradient(circle, rgba(255,255,255,.9), rgba(255,205,140,.25) 40%, rgba(255,205,140,0) 70%);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 22px rgba(255,205,140,.18);
    }
    .readout{
  max-width: 1100px;
  margin: 12px auto 0;
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
  opacity: .55;
  text-align: center;
}

.p-codex{ left:50%; top:58%; transform:translate(-50%,-50%); }

.mode-live{ animation: pulse 2.6s ease-in-out infinite; }
.mode-quiet{ opacity: .75; }
.mode-dark{ opacity: .35; filter: saturate(.6); }

.state-open{ animation: pulse 3.2s ease-in-out infinite; }
.state-quiet{ opacity: .7; }
.state-closed{ opacity: .35; }

@keyframes pulse{
  0%{ transform: translate(-50%,-50%) scale(0.9); opacity: .6; }
  50%{ transform: translate(-50%,-50%) scale(1.25); opacity: 1; }
  100%{ transform: translate(-50%,-50%) scale(0.9); opacity: .6; }
}

/* Important: pulse animation assumes pin uses translate(-50%,-50%).
   For pins that use different positioning, we keep pulse only on those. */
.p-now.mode-live,
.p-courtyard.state-open,
.p-codex{
  /* these pins already use translate(-50%,-50%) */
}


    .p-now{ left:50%; top:40%; transform:translate(-50%,-50%); }
    .p-walk{ left:26%; top:62%; transform:translate(-50%,-50%); }
    .p-courtyard{ left:72%; top:58%; transform:translate(-50%,-50%); }

    .glyph{
      position:absolute;
      left:50%; bottom:22px; transform:translateX(-50%);
      border-radius:999px;
      padding:10px 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      opacity:.85;
    }
    .glyph:hover{ opacity:1; }
  </style>

  <script type="module">
    const go = () => (location.href = "/now");
    document.getElementById("glyph")?.addEventListener("click", go);
    // setTimeout(go, 4200);
  </script>
</SkyLayout>
