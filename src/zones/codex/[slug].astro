---
export const prerender = false;

import fs from "fs";
import path from "path";
import { marked } from "marked";
import SkyLayout from "@/layouts/SkyLayout.astro";

const REG_PATH = path.join(process.cwd(), "starmap/registry/index.json");
const registry = JSON.parse(fs.readFileSync(REG_PATH, "utf-8"));

const { slug } = Astro.params;

const entry = registry.find((e) => e.type === "codex" && e.slug === slug);
if (!entry) return new Response("Not Found", { status: 404 });

const filePath = path.join(process.cwd(), "starmap", entry.path);
if (!fs.existsSync(filePath)) return new Response("Missing file", { status: 404 });

const markdown = fs.readFileSync(filePath, "utf-8");
const html = marked.parse(markdown);

const stats = fs.statSync(filePath);
---
<SkyLayout title={entry.title} bg="sky">
  <a href="/codex" style="display:inline-block; opacity:.75; text-decoration:none; margin-bottom:1rem;">
    ‚Üê back to Codex
  </a>

  <h1>{entry.title}</h1>

  <article class="prose" set:html={html} />

  <style>
  .prose {
    max-width: 52rem;
    margin: 0 auto;
    line-height: 1.7;
    color: rgba(235,238,255,0.88);
  }
  .prose h1, .prose h2, .prose h3 {
    margin-top: 1.6rem;
    margin-bottom: 0.7rem;
    letter-spacing: 0.02em;
  }
  .prose p { margin: 0.85rem 0; }
  .prose ul, .prose ol { padding-left: 1.25rem; margin: 0.85rem 0; }
  .prose li { margin: 0.35rem 0; }
  .prose a { opacity: 0.9; }
  .prose a:hover { opacity: 1; }
  .prose code {
    font-size: 0.92em;
    padding: 0.12em 0.35em;
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 8px;
    background: rgba(0,0,0,.25);
  }
  .prose pre {
    padding: 0.9rem 1rem;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.28);
    overflow-x: auto;
  }
  .prose pre code { border: none; padding: 0; background: transparent; }
  .prose blockquote {
    margin: 1rem 0;
    padding-left: 1rem;
    border-left: 2px solid rgba(255,255,255,.18);
    opacity: 0.85;
  }
</style>

  <footer style="margin-top:2.5rem; opacity:.55; font-size:.9rem;">
    <hr style="border:0; border-top:1px solid rgba(255,255,255,.10); margin:1.25rem 0;" />
    Last updated: {stats.mtime.toLocaleString()}
  </footer>
</SkyLayout>
