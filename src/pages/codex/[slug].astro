---
export const prerender = false;

import fs from "fs";
import path from "path";
import { marked } from "marked";

// ğŸ“ Load registry
const REG_PATH = path.join(process.cwd(), "starmap/registry/index.json");
const registry = JSON.parse(fs.readFileSync(REG_PATH, "utf-8"));

// ğŸ“ Get slug from URL
const { slug } = Astro.params;

// ğŸ“ Find matching registry entry
const entry = registry.find(
  (e) => e.type === "codex" && e.slug === slug
);

// ğŸš« If not registered â†’ 404
if (!entry) {
  return new Response("Not Found", { status: 404 });
}

// ğŸ“ Build path from registry (not guessing)
const filePath = path.join(process.cwd(), "starmap", entry.path);

// ğŸš« If file missing â†’ error
if (!fs.existsSync(filePath)) {
  return new Response("Missing file", { status: 404 });
}

// ğŸ“ Read + render markdown
const markdown = fs.readFileSync(filePath, "utf-8");
const html = marked.parse(markdown);

// ğŸ“ Get file stats (for footer)
const stats = fs.statSync(filePath);
---

<html>
  <body>
    <a href="/codex">â† Back to Codex</a>
    <h1>{entry.title}</h1>
    <article set:html={html} />

   <footer>
  <hr />
  <small>
    Last updated: {stats.mtime.toLocaleString()}
  </small>
</footer>
  </body>
</html>
