---
// src/components/WallCardsModal.astro
// Modal Overlay wall-cards (no framework; Astro + vanilla JS)
type Card = {
  id: string;
  title: string;
  category?: string;
  bullets: string[];
  meta?: string; // e.g. "Last revised: 2026-02-17"
};

const {
  cards,
  heading = "Wall System",
  subheading = "Clean modular grid. Click a card to open.",
} = Astro.props as {
  cards: Card[];
  heading?: string;
  subheading?: string;
};
---

<section class="wall">
  <header class="wall-head">
    <h2>{heading}</h2>
    <p>{subheading}</p>
  </header>

  <div class="wall-grid" role="list">
    {cards.map((c) => (
      <button
        class="wall-card"
        type="button"
        role="listitem"
        data-card
        data-id={c.id}
        aria-haspopup="dialog"
        aria-controls="wall-modal"
      >
        <div class="card-top">
          <span class="card-title">{c.title}</span>
          {c.category ? <span class="card-tag">{c.category}</span> : null}
        </div>
        <div class="card-hint">Open</div>
      </button>
    ))}
  </div>

  {/* Modal overlay */}
  <dialog id="wall-modal" class="modal" aria-labelledby="modal-title">
    <form method="dialog" class="modal-shell">
      <button class="modal-x" value="close" aria-label="Close">âœ•</button>

      <div class="modal-body" role="document">
        <div class="modal-head">
          <h3 id="modal-title"></h3>
          <div id="modal-meta" class="modal-meta"></div>
        </div>

        <ul id="modal-bullets" class="modal-bullets"></ul>

        <div class="modal-actions">
          <button class="btn" value="close">Close</button>
          <button class="btn ghost" type="button" data-pin disabled title="Pin (later)">Pin</button>
          <button class="btn ghost" type="button" data-compare disabled title="Compare (later)">Compare</button>
        </div>
      </div>
    </form>
  </dialog>

  {/* Data payload (so JS can look up bullets/meta) */}
  <script type="application/json" id="wall-cards-data">
    {JSON.stringify(cards)}
  </script>

  <script type="module">
    const dataEl = document.getElementById("wall-cards-data");
    const cards = JSON.parse(dataEl?.textContent || "[]");
    const byId = new Map(cards.map((c) => [c.id, c]));

    const modal = document.getElementById("wall-modal");
    const titleEl = document.getElementById("modal-title");
    const metaEl = document.getElementById("modal-meta");
    const bulletsEl = document.getElementById("modal-bullets");

    let lastFocused = null;

    function renderCard(id){
      const c = byId.get(id);
      if(!c) return;
      titleEl.textContent = c.title || "";
      metaEl.textContent = c.meta || "";
      bulletsEl.innerHTML = "";
      (c.bullets || []).forEach((b) => {
        const li = document.createElement("li");
        li.textContent = b;
        bulletsEl.appendChild(li);
      });
    }

    function openModal(fromBtn, id){
      lastFocused = fromBtn;
      renderCard(id);

      // Prefer native <dialog>
      if (typeof modal.showModal === "function") {
        modal.showModal();
      } else {
        // Fallback: emulate open
        modal.setAttribute("open", "");
      }

      // Focus first focusable element inside
      const focusable = modal.querySelector(".modal-x");
      focusable?.focus();
    }

    function closeModal(){
      if (typeof modal.close === "function") modal.close();
      else modal.removeAttribute("open");
      lastFocused?.focus?.();
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-card]");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      openModal(btn, id);
    });

    // Close on backdrop click (click outside modal shell)
    modal?.addEventListener("click", (e) => {
      const shell = modal.querySelector(".modal-shell");
      if(shell && !shell.contains(e.target)) closeModal();
    });

    // Close on Esc
    modal?.addEventListener("keydown", (e) => {
      if(e.key === "Escape") {
        e.preventDefault();
        closeModal();
      }
      // basic focus trap
      if(e.key === "Tab"){
        const focusables = modal.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const list = Array.from(focusables).filter(el => !el.disabled);
        if(!list.length) return;
        const first = list[0];
        const last = list[list.length - 1];
        if(e.shiftKey && document.activeElement === first){
          e.preventDefault(); last.focus();
        } else if(!e.shiftKey && document.activeElement === last){
          e.preventDefault(); first.focus();
        }
      }
    });

    // If form "Close" or "X" pressed
    modal?.addEventListener("close", closeModal);

    // If dialog isn't supported, the "close" event may not fire reliably.
    modal?.querySelectorAll('[value="close"]').forEach((b) => {
      b.addEventListener("click", (e) => {
        e.preventDefault();
        closeModal();
      });
    });
  </script>

  <style>
    /* Base rhythm (8px unit) */
    .wall{ margin-top: 20px; }
    .wall-head h2{ margin: 0; font-size: 16px; letter-spacing: .02em; }
    .wall-head p{ margin: 6px 0 0; opacity: .72; font-size: 12px; max-width: 70ch; }

    .wall-grid{
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 900px){
      .wall-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .wall-grid{ grid-template-columns: 1fr; }
    }

    .wall-card{
      appearance: none;
      text-align: left;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 12px;
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.90);
      cursor: pointer;
      opacity: .78;
      transform: translateY(0);
      transition: transform 140ms ease, opacity 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      min-height: 96px;
    }
    .wall-card:hover,
    .wall-card:focus-visible{
      opacity: 1;
      transform: translateY(-2px);
      border-color: rgba(160, 200, 160, .28); /* olive edge */
      box-shadow: 0 16px 44px rgba(0,0,0,.28);
      outline: none;
    }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .card-title{ font-size: 13px; line-height: 1.25; }
    .card-tag{
      font-size: 11px;
      opacity: .75;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(160, 200, 160, .22);
      background: rgba(120, 170, 120, .10);
      white-space: nowrap;
    }
    .card-hint{
      margin-top: 10px;
      font-size: 11px;
      opacity: .55;
      letter-spacing: .08em;
      text-transform: uppercase;
    }

    /* Modal overlay */
    .modal{
      width: min(720px, 92vw);
      border: 0;
      padding: 0;
      border-radius: 16px;
      background: rgba(10,10,12,.72);
      color: rgba(255,255,255,.92);
      box-shadow: 0 40px 120px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .modal::backdrop{
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(3px);
    }

    .modal-shell{
      margin: 0;
      padding: 16px;
      position: relative;
      background:
        radial-gradient(900px 520px at 50% 20%, rgba(255,255,255,.06), rgba(0,0,0,0)),
        radial-gradient(760px 420px at 50% 72%, rgba(255,205,140,.10), rgba(0,0,0,0)),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.78));
    }

    .modal-x{
      position:absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.85);
      cursor: pointer;
    }
    .modal-x:hover,
    .modal-x:focus-visible{
      outline: none;
      border-color: rgba(255,205,140,.40);
    }

    .modal-head h3{
      margin: 0;
      font-size: 18px;
      letter-spacing: .01em;
    }
    .modal-meta{
      margin-top: 6px;
      font-size: 12px;
      opacity: .68;
    }

    .modal-bullets{
      margin: 14px 0 0;
      padding-left: 18px;
      line-height: 1.5;
      font-size: 13px;
      opacity: .92;
    }
    .modal-bullets li{ margin: 8px 0; }

    .modal-actions{
      margin-top: 16px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.88);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
    }
    .btn:hover,
    .btn:focus-visible{
      outline: none;
      border-color: rgba(255,205,140,.40);
    }
    .btn.ghost{
      opacity: .65;
    }
    .btn:disabled{
      cursor: not-allowed;
      opacity: .35;
    }
  </style>
</section>
